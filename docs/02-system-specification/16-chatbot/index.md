---
title: チャットボット機能
---

# チャットボット機能

## 概要

日本語学校運営の初心者でも、チャットで質問するだけで業務知識の取得・データの照会/出力・データの変更ができる機能。
[システムコンセプト](../00-concept/index.md) の「人間の考える作業を最小化する」「入力を最小化する」を実現する中核機能。

## 4つのモード

チャットボットは、ユーザーの入力内容に応じて4つのモードを自動判別して動作する。

| # | モード | 起点 | 処理 | 出力 |
|---|--------|------|------|------|
| 1 | **ナレッジ回答** | 「入管届出の期限は？」 | VitePress Markdown を参照 | テキスト回答 + ドキュメントリンク |
| 2 | **データ照会・出力** | 「出席率80%以下の子を出して」 | DB検索 → 加工 | 画面に表形式 + CSV/Excelダウンロード |
| 3 | **データ変更** | 「AさんがX寮からY寮に引っ越した」 | 変更内容を解釈 → 確認 → DB更新 | 変更結果の表示 |
| 4 | **ナレッジ更新** | 「入管法のルールが変わった」 | 更新内容を解釈 → 決裁申請 → Markdown更新 | 更新結果の表示 |

## プロジェクト機能との違い

どちらもチャットUIだが、目的と動き方が異なる。
詳細は [プロジェクト機能](../00-concept/02-project-feature.md) を参照。

| | チャットボット | プロジェクト機能 |
|---|---|---|
| **起点** | 人間が自由に話しかける | システムがスキルを提示する |
| **操作** | 自由な対話 | 定義されたワークフローに沿って進行 |
| **データ操作** | 既存データの読み書き・修正 | 新しいデータの追加が中心 |
| **例** | 「未納者出して」「寮を変更して」 | 「2026年4月募集」で書類生成まで進行 |

## AIエンジン

Claude API を使用。Tool Use 機能で DB 操作・ファイル出力・ナレッジ更新を実現する。

- Claude が「どの関数を呼ぶか」を判断する
- 実際の DB 処理・ファイル生成はサーバー側で実行
- Tool Use で呼び出す関数は、各カテゴリのエンティティ定義と対応する

## ナレッジソース

VitePress の Markdown ファイル群がナレッジの唯一のソース。

| フェーズ | 方式 | 説明 |
|----------|------|------|
| 初期 | **全文注入** | Markdown 全文を Claude API の system prompt に注入。シンプルだがAPI費用が高い |
| 将来 | **RAG** | 質問に関連する部分だけ検索して注入。費用を抑えつつ精度も向上 |

マニュアル（Markdown）を更新すれば、ドキュメントサイトも AI の回答も同時に更新される。

## 認証・権限

ログインユーザーのみ使用可能。3つのロールで機能を制限する。

| ロール | ナレッジ回答 | データ照会 | データ変更 | ナレッジ更新 | 決裁 |
|--------|:---:|:---:|:---:|:---:|:---:|
| **一般ユーザー** | OK | OK | NG | NG | NG |
| **管理者** | OK | OK | OK | 申請のみ | NG |
| **決裁者** | OK | OK | OK | 申請のみ | OK |

### 決裁フロー

- **データ変更**: 決裁者がいる場合 → 承認依頼が飛ぶ。いない場合 → 管理者が確認ステップのみで即実行
- **ナレッジ更新**: **必ず決裁者の承認が必要**（法令・業務ルールの変更は影響が大きいため）

## 変更履歴（Audit Log）

データ変更・ナレッジ更新は全て `AuditLog` テーブルに記録する。

- **誰が**（操作ユーザー）
- **いつ**（タイムスタンプ）
- **何を**（対象テーブル・レコード・フィールド）
- **どう変えたか**（変更前の値 → 変更後の値）

チャットボット経由の変更だけでなく、将来的には画面からの直接変更も同じテーブルに記録する。

## チャット履歴

過去の会話を保存し、見返せるようにする。

- 会話はセッション（スレッド）単位で保存
- 過去のセッション一覧を表示・検索できる

## ファイル保存先

チャットボット経由でアップロードされたファイル（契約書など）は **Box** に保存する。

- 現在のBoxアカウントを使用
- 将来的にはファイル専用の別Boxアカウントに移行予定（在留カード等で容量増加が見込まれるため）

## 法令情報の定期アップデート

入管法等の法令は変更が多いため、半年に1回程度、手動でナレッジ更新を指示する運用。

- ユーザーが「最新の入管法で変更ないか確認して、ナレッジ更新して」とチャットで指示
- チャットボットが最新情報を調べ、変更があればナレッジ更新を提案
- 決裁フローを通して Markdown に反映
