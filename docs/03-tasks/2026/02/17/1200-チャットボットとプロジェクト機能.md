---
title: チャットボット機能 + プロジェクト機能の実装
status: 対応中
---

# チャットボット機能 + プロジェクト機能の実装

## 参照ドキュメント

### チャットボット機能
- `docs/02-system-specification/16-chatbot/index.md` — 概要・4モード・権限・決裁フロー
- `docs/02-system-specification/16-chatbot/01-entity.md` — ChatSession, ChatMessage, AuditLog, ApprovalRequest
- `docs/02-system-specification/16-chatbot/02-uiux.md` — 画面構成・モード別フロー・Tool Use 関数カテゴリ

### プロジェクト機能
- `docs/02-system-specification/18-project/index.md` — 概要・スキル管理・権限・決裁フロー
- `docs/02-system-specification/18-project/01-entity.md` — Skill, SkillTaskTemplate, SkillConditionRule, Project, ProjectTask, ProjectMember
- `docs/02-system-specification/18-project/02-uiux.md` — 画面構成・UIフロー

### 共通
- `docs/02-system-specification/00-concept/index.md` — システムコンセプト
- `docs/02-system-specification/00-concept/02-project-feature.md` — プロジェクト機能コンセプト

## 確認事項

| # | 質問 | 回答 |
|---|------|------|
| 1 | 開発順序 | 両方同時に進める |
| 2 | プロジェクト機能の実装範囲 | チャット連携・成果物生成含めフル実装 |
| 3 | 認証の User モデル | 既存は Supabase Auth。仕様書では User に role 追加が必要。Staff テーブルとの関係を整理する必要あり |

## 技術的判断

### User と Staff の関係

仕様書では `User` テーブルに `role` を追加するとあるが、既存システムは `Staff` テーブルが実質的なユーザーマスタ。
Supabase Auth の uid と Staff.id は別物。

**方針**: Staff テーブルに `userRole`（UserRole enum: GENERAL / ADMIN / APPROVER）を追加する。
Supabase Auth の uid → Staff への紐づけは `Staff.email` と Auth user の email で突合する既存の仕組みを利用。

### 監査フィールドのパターン

既存モデルは `createdById / updatedById` → Staff への FK。
チャットボット新規モデル（ChatSession 等）も同じパターンを踏襲する。
ただし ChatSession.userId は Supabase Auth の UID を直接保持（Staff が存在しないユーザーもチャットは使える設計の余地を残す）。

## 実装項目チェックリスト

### Phase 1: 共通基盤（User role 拡張・AuditLog・ApprovalRequest）

DB スキーマの変更が伴うため、最初に実施。

- [ ] **1-1. Staff テーブルに userRole を追加**
  - `packages/database/prisma/schema/staff.prisma`
  - `UserRole` enum: GENERAL / ADMIN / APPROVER
  - デフォルト: GENERAL
  - マイグレーション SQL を同梱

- [ ] **1-2. UserRole の Value Object を追加**
  - `packages/domain/src/value-object/user-role.vo.ts`
  - `value-object/index.ts` にエクスポート追加

- [ ] **1-3. チャットボット用 Prisma スキーマ追加**
  - `packages/database/prisma/schema/chatbot.prisma`
  - ChatSession, ChatMessage モデル
  - MessageRole enum: USER / ASSISTANT / SYSTEM

- [ ] **1-4. 監査・決裁用 Prisma スキーマ追加**
  - `packages/database/prisma/schema/audit.prisma`
  - AuditLog, ApprovalRequest モデル
  - AuditAction, ApprovalType, ApprovalStatus enum

- [ ] **1-5. チャットボット用 Value Object 追加**
  - message-role.vo.ts, audit-action.vo.ts, approval-type.vo.ts, approval-status.vo.ts

- [ ] **1-6. マイグレーション SQL 生成**
  - `prisma migrate diff` で SQL 生成
  - ユーザーに Supabase SQL Editor での実行を依頼

- [ ] **1-7. ビルド確認**

### Phase 2: プロジェクト機能 — DB スキーマ

- [ ] **2-1. プロジェクト用 Prisma スキーマ追加**
  - `packages/database/prisma/schema/project.prisma`
  - Skill, SkillTaskTemplate, SkillConditionRule モデル
  - Project, ProjectTask, ProjectMember モデル

- [ ] **2-2. プロジェクト用 Enum を Prisma に追加**
  - TaskCategory, TaskActionType, ConditionOperator
  - ProjectStatus, ProjectTaskStatus, ProjectRole

- [ ] **2-3. プロジェクト用 Value Object 追加**
  - task-category.vo.ts, task-action-type.vo.ts, condition-operator.vo.ts
  - project-status.vo.ts, project-task-status.vo.ts, project-role.vo.ts

- [ ] **2-4. マイグレーション SQL 生成**

- [ ] **2-5. ビルド確認**

### Phase 3: チャットボット機能 — API

- [ ] **3-1. チャットセッション API**
  - `apps/web/app/api/chat/sessions/route.ts` — GET（一覧）, POST（新規作成）
  - `apps/web/app/api/chat/sessions/[id]/route.ts` — GET, DELETE

- [ ] **3-2. チャットメッセージ API**
  - `apps/web/app/api/chat/sessions/[id]/messages/route.ts` — GET（履歴）, POST（送信）

- [ ] **3-3. Claude API 連携の基盤**
  - `apps/web/lib/chat/claude-client.ts` — Claude API クライアント
  - `apps/web/lib/chat/tools/index.ts` — Tool Use 定義のエントリポイント
  - `apps/web/lib/chat/system-prompt.ts` — システムプロンプト構築

- [ ] **3-4. Tool Use 関数 — データ照会系**
  - 学生検索、出席照会、学費照会、エージェント照会、施設照会、入管タスク照会

- [ ] **3-5. Tool Use 関数 — データ変更系**
  - 学生情報更新、施設情報更新、出席修正
  - AuditLog への記録ロジック

- [ ] **3-6. 決裁 API**
  - `apps/web/app/api/chat/approvals/route.ts` — GET（一覧）
  - `apps/web/app/api/chat/approvals/[id]/route.ts` — PATCH（承認/却下）

- [ ] **3-7. ビルド確認**

### Phase 4: プロジェクト機能 — API

- [ ] **4-1. スキル管理 API**
  - `apps/web/app/api/projects/skills/route.ts` — GET, POST
  - `apps/web/app/api/projects/skills/[id]/route.ts` — GET, PATCH

- [ ] **4-2. プロジェクト API**
  - `apps/web/app/api/projects/route.ts` — GET（一覧）, POST（新規作成 + タスク自動生成）
  - `apps/web/app/api/projects/[id]/route.ts` — GET, PATCH

- [ ] **4-3. プロジェクトタスク API**
  - `apps/web/app/api/projects/[id]/tasks/route.ts` — GET
  - `apps/web/app/api/projects/[id]/tasks/[taskId]/route.ts` — PATCH（ステータス変更・ファイルパス・メモ）

- [ ] **4-4. プロジェクトメンバー API**
  - `apps/web/app/api/projects/[id]/members/route.ts` — GET, POST
  - `apps/web/app/api/projects/[id]/members/[memberId]/route.ts` — PATCH, DELETE

- [ ] **4-5. 条件分岐ロジック**
  - `apps/web/lib/project/condition-evaluator.ts` — 条件分岐ルールの評価
  - プロジェクト作成時にタスクの必要/不要を自動判定

- [ ] **4-6. 初期スキルデータ（特定技能申請）のシード**
  - `packages/database/prisma/seed/ssw-skill.ts`
  - 36タスクテンプレート + 条件分岐ルール

- [ ] **4-7. ビルド確認**

### Phase 5: チャットボット機能 — 画面

- [ ] **5-1. チャットメイン画面**
  - `apps/web/app/(auth)/chat/page.tsx`
  - セッション一覧サイドバー + チャット領域 + 入力欄

- [ ] **5-2. チャットメッセージ表示**
  - テキスト回答、テーブル表示、確認画面（データ変更・ナレッジ更新）
  - CSV/Excel ダウンロードボタン

- [ ] **5-3. 決裁一覧画面**
  - `apps/web/app/(auth)/chat/approvals/page.tsx`
  - 承認待ち・承認済み・却下のフィルタ

- [ ] **5-4. サイドバーナビゲーション追加**
  - layout.tsx の menuItems に「チャット」を追加

- [ ] **5-5. ビルド確認**

### Phase 6: プロジェクト機能 — 画面

- [ ] **6-1. プロジェクト一覧画面**
  - `apps/web/app/(auth)/projects/page.tsx`
  - 進行中・完了・全てのフィルタ、進捗バー

- [ ] **6-2. プロジェクト詳細画面（タスクボード）**
  - `apps/web/app/(auth)/projects/[id]/page.tsx`
  - タスクボード（左）+ チャット（右）の2カラム構成

- [ ] **6-3. 新規プロジェクト作成フロー**
  - `apps/web/app/(auth)/projects/new/page.tsx`
  - ステップ1: スキル選択 → ステップ2: 学生選択 → ステップ3: 企業選択 → 作成

- [ ] **6-4. タスク操作モーダル**
  - ステータス変更、担当者設定、ファイルアップロード、メモ入力

- [ ] **6-5. メンバー管理モーダル**

- [ ] **6-6. スキル管理画面**
  - `apps/web/app/(auth)/projects/skills/page.tsx`

- [ ] **6-7. サイドバーナビゲーション追加**
  - layout.tsx の menuItems に「プロジェクト」を追加

- [ ] **6-8. ビルド確認**

### Phase 7: テスト

- [ ] **7-1. チャットボット API テスト**
  - `apps/web/__tests__/api/chat/` 配下

- [ ] **7-2. プロジェクト API テスト**
  - `apps/web/__tests__/api/projects/` 配下

- [ ] **7-3. 条件分岐ロジックのユニットテスト**

### Phase 8: 最終確認・ドキュメント同期

- [ ] **8-1. 全体ビルド確認** (`npm run docs:build` + TypeScript チェック)
- [ ] **8-2. 仕様書との突合**
- [ ] **8-3. VitePress サイドバー設定更新**（必要に応じて）

## 申送事項

- ナレッジ操作系 Tool Use（Markdown 検索・更新）は初期実装では VitePress のビルドパイプラインとの連携が複雑。初期は「ナレッジ回答」モードのみ system prompt 全文注入で対応し、ナレッジ更新はフラグだけ立てて手動反映とする
- Box API 連携（ファイルアップロード・検索）は Box MCP が利用可能であれば連携。なければファイルパスの文字列管理のみ
- Excel/CSV 生成はサーバーサイドで実装。ライブラリは xlsx (SheetJS) を使用予定
- 初期スキルのシードデータは特定技能申請スキルのみ。募集活動・ビザ更新は将来追加
