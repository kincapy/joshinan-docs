---
title: プロジェクト機能改修（仕様再設計 → 実装反映）
status: 対応中
---

# プロジェクト機能改修（仕様再設計 → 実装反映）

## 概要

PR #43 で策定したプロジェクト機能の仕様再設計を、既存の実装に反映する。
ウィザードのステップ変更、条件分岐の簡素化、4タブ構成、タスク詳細ページ、書類一括アップロード、AI自動入力の実装。

## 参照ドキュメント

- `docs/02-system-specification/18-project/index.md` — プロジェクト機能概要
- `docs/02-system-specification/18-project/01-entity.md` — エンティティ定義（ProjectTaskStatusLog追加済み）
- `docs/02-system-specification/18-project/02-uiux.md` — UIUX定義（4タブ・タスク詳細・一括アップロード設計済み）

## 既存実装の状況

| レイヤー | ファイル | 状態 |
|---------|---------|------|
| DB スキーマ | `packages/database/prisma/schema/project.prisma` | 6テーブル定義済み。ProjectTaskStatusLog 未定義 |
| シードデータ | `packages/database/prisma/migrations/seed_ssw_application_skill.sql` | 36タスク+13条件ルール（旧仕様） |
| API | `apps/web/app/api/projects/` | 8エンドポイント実装済み |
| 画面（一覧） | `apps/web/app/(auth)/projects/page.tsx` | 実装済み |
| 画面（詳細） | `apps/web/app/(auth)/projects/[id]/page.tsx` | 2タブ（タスクボード/メンバー）で実装済み |
| 画面（新規作成） | `apps/web/app/(auth)/projects/new/page.tsx` | 旧仕様のフォーム（保険・年金・技能実習あり） |
| 画面（スキル管理） | `apps/web/app/(auth)/projects/skills/page.tsx` | 実装済み |
| タスク詳細ページ | なし | 未実装 |
| Value Objects | `packages/domain/` | ProjectStatus, ProjectRole, ProjectTaskStatus 等 実装済み |

## 実装項目チェックリスト

### Phase 1: DBスキーマ変更

- [ ] **1-1. ProjectTaskStatusLog モデルを Prisma に追加**
  - `packages/database/prisma/schema/project.prisma`
  - 仕様: `01-entity.md` の ProjectTaskStatusLog
  - ProjectTask との 1:N リレーション追加
  - マイグレーション SQL 生成

- [ ] **1-2. シードデータの更新**
  - `packages/database/prisma/migrations/seed_ssw_application_skill.sql`
  - DAT-001 タスクテンプレートを追加（sortOrder: 0、DOC系より前）
  - COL-008〜011 の defaultRequired を true に変更（保険・年金は全員必須に）
  - 条件ルール7件を削除（hasCompletedTitp2 × 2、insuranceType × 2、pensionType × 2、合計6件。ルール13→7件→さらに調整で4件）
  - 残す条件ルール: COL-020(介護), COL-021(宿泊), COL-022+023(自動車運送), COL-019(国籍)

- [ ] **1-3. ビルド確認**

### Phase 2: API 改修

- [ ] **2-1. プロジェクト作成 API の改修**
  - `apps/web/app/api/projects/route.ts` (POST)
  - contextData に studentId を受け取り、学生DBから国籍を自動取得
  - プロジェクト名の自動生成（「{学生名}の{スキル名}」）
  - 旧条件分岐（insuranceType, pensionType, hasCompletedTitp2）の処理を削除

- [ ] **2-2. タスク詳細 API の拡充**
  - `apps/web/app/api/projects/[id]/tasks/[taskId]/route.ts` (PATCH)
  - filePath, notes, assigneeId の更新を追加
  - ステータス変更時に ProjectTaskStatusLog に記録

- [ ] **2-3. タスクステータス履歴 API**
  - `apps/web/app/api/projects/[id]/tasks/[taskId]/route.ts` (GET)
  - タスク詳細 + ステータス変更履歴を返す

- [ ] **2-4. 書類一括アップロード解析 API**
  - `apps/web/app/api/projects/[id]/bulk-upload/route.ts` (POST)
  - アップロードされたファイル群を Claude API で解析
  - 各ファイルの振り分け先タスクコードと信頼度を返す

- [ ] **2-5. 書類一括格納 API**
  - `apps/web/app/api/projects/[id]/bulk-upload/confirm/route.ts` (POST)
  - 解析結果を受けて各タスクにファイルを格納、ステータスを更新

- [ ] **2-6. ビルド確認**

### Phase 3: フロントエンド — ウィザード改修

- [ ] **3-1. ウィザード形式に変更**
  - `apps/web/app/(auth)/projects/new/page.tsx`
  - 3ステップ: スキル選択 → 学生選択 → 職種選択
  - 保険・年金・技能実習の選択肢を削除
  - プロジェクト名を自動生成（手動入力は不要）

- [ ] **3-2. 学生検索コンポーネント**
  - 学生APIで検索 → ラジオボタンで選択
  - 選択した学生の国籍を自動取得して contextData に含める

- [ ] **3-3. ビルド確認**

### Phase 4: フロントエンド — 4タブ構成 + タスク詳細ページ

- [ ] **4-1. プロジェクト詳細画面を4タブに変更**
  - `apps/web/app/(auth)/projects/[id]/page.tsx`
  - タブ: 当社作成 / 申請人 / 企業 / 最終提出
  - 各タブに完了数/必須数を表示
  - タスク行クリックでタスク詳細ページに遷移
  - ヘッダーに「書類をまとめてアップロード」ボタンを追加

- [ ] **4-2. タスク詳細ページ（DAT系: フォーム入力）**
  - `apps/web/app/(auth)/projects/[id]/tasks/[taskCode]/page.tsx`
  - DAT-001 の企業情報入力フォーム
  - ステータス変更セレクト
  - ステータス変更履歴の表示
  - 「書類アップロード（任意）」セクション

- [ ] **4-3. タスク詳細ページ（COL系: ファイルアップロード）**
  - 同ページでタスクコードに応じて切り替え
  - ファイルアップロードエリア
  - 担当者選択、メモ入力
  - ステータス変更履歴の表示

- [ ] **4-4. タスク詳細ページ（REV-001: 最終確認）**
  - 提出準備チェック（各カテゴリの完了状況）
  - 未完了タスク一覧
  - 申請書類セット生成ボタン（全タスク完了後に有効化）

- [ ] **4-5. ビルド確認**

### Phase 5: フロントエンド — 書類一括アップロード

- [ ] **5-1. 一括アップロードモーダル**
  - `apps/web/app/(auth)/projects/[id]/components/BulkUploadModal.tsx`
  - ドラッグ＆ドロップでファイル選択
  - 「AIで解析して振り分ける」ボタン

- [ ] **5-2. AI解析結果の確認画面**
  - 振り分け先タスク + 信頼度の表示
  - 振り分け先の手動変更（セレクトで別タスクを選択）
  - 「確定して格納する」ボタン

- [ ] **5-3. ビルド確認**

### Phase 6: AI自動データ入力

- [ ] **6-1. Claude API クライアント（書類解析用）**
  - `apps/web/lib/project/document-analyzer.ts`
  - アップロードされた書類をClaude APIで解析
  - 書類種別の判定 + データ読み取り

- [ ] **6-2. DAT-001 フォームへの自動入力**
  - 以前の申請書をアップロード → 企業情報を読み取り → フォームに自動入力
  - ユーザーに確認画面を表示してから反映

- [ ] **6-3. 一括アップロード解析ロジック**
  - 複数ファイルをまとめて1回のAPI呼び出しで解析
  - タスクコード一覧をコンテキストに渡して振り分け先を判定
  - 信頼度（高/中/低）の判定ロジック

- [ ] **6-4. ビルド確認**

### Phase 7: テスト

- [ ] **7-1. プロジェクト作成 API テスト（改修部分）**
  - `apps/web/__tests__/api/projects/`
  - 新しい contextData 形式（studentId + sswField）でのテスト
  - 条件分岐が4ルールに簡素化されていることの確認

- [ ] **7-2. タスク詳細 API テスト**
  - ステータス変更 + StatusLog 記録のテスト

- [ ] **7-3. 書類一括アップロード API テスト**

### Phase 8: 最終確認・ドキュメント同期

- [ ] **8-1. 全体ビルド確認** (`npm run docs:build` + TypeScript チェック)
- [ ] **8-2. 仕様書との突合**（index.md, 01-entity.md, 02-uiux.md と実装が一致しているか）
- [ ] **8-3. VitePress サイドバー設定更新**（必要に応じて）

## DB変更の事前報告

**ユーザーへの確認が必要な項目:**

1. **ProjectTaskStatusLog テーブルの新規追加**
   - タスクのステータス変更履歴を記録するテーブル
   - カラム: id, taskId, fromStatus, toStatus, changedById, changedAt
   - マイグレーション SQL を Supabase SQL Editor で手動実行する必要がある

2. **シードデータの更新**
   - DAT-001 タスクテンプレートの追加
   - 条件ルール 13件 → 4件に削減
   - COL-008〜011 の defaultRequired を true に変更
   - 既存のシードデータがある場合は UPDATE/DELETE で対応

## コスト管理の注意点

- Claude API の呼び出しは「AIで解析して振り分ける」ボタン押下時のみ
- 1回のAPI呼び出しで全ファイルをまとめて解析する
- 開発環境ではモックデータで動作確認し、本番環境でのみ実際のAPI呼び出しを行う

## 申送事項

- 学生検索APIが必要（既存の学生マスタAPIを使用。なければ作成）
- Box API 連携（ファイルアップロード）は、ファイルパスの文字列管理のみで初期実装
- 書類一括アップロードのAI解析は、コスト管理のためステージング環境でまず検証
