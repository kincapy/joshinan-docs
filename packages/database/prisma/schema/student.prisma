/// =============================================
/// 学生管理 (02-student-management)
/// =============================================

/// 性別
enum Gender {
  MALE   /// 男性
  FEMALE /// 女性
}

/// 学生ステータス
enum StudentStatus {
  PRE_ENROLLMENT /// 入学前
  ENROLLED       /// 在学
  ON_LEAVE       /// 休学
  WITHDRAWN      /// 退学
  EXPELLED       /// 除籍
  GRADUATED      /// 卒業
  COMPLETED      /// 修了
}

/// 入学前詳細ステータス
enum PreEnrollmentStatus {
  APPLICATION_PLANNED /// 申請予定
  GRANTED             /// 入学予定（COE交付済み）
  NOT_GRANTED         /// 不交付
  DECLINED            /// 入学辞退
}

/// 入学コホート
enum Cohort {
  APRIL   /// 4月生（2年間）
  JULY    /// 7月生（1年9ヶ月）
  OCTOBER /// 10月生（1年6ヶ月）
  JANUARY /// 1月生（1年3ヶ月）
}

/// 進路区分
enum CareerPath {
  FURTHER_EDUCATION /// 進学
  EMPLOYMENT        /// 就職
  RETURN_HOME       /// 帰国
}

/// 進路合否
enum CareerResult {
  PENDING  /// 未定
  ACCEPTED /// 合格
  REJECTED /// 不合格
}

/// 面談種別
enum InterviewType {
  CAREER        /// 進路相談
  ATTENDANCE    /// 出席指導
  LIFE_GUIDANCE /// 生活指導
  OTHER         /// その他
}

/// 試験種別
enum ExamType {
  JLPT      /// 日本語能力試験（N1〜N5）
  JFT_BASIC /// 国際交流基金日本語基礎テスト
  NAT_TEST  /// NAT-TEST
  J_TEST    /// J-TEST（実用日本語検定）
  SSW_SKILL /// 特定技能評価試験（技能）
  OTHER     /// その他
}

/// 試験結果
enum ExamResult {
  PASSED  /// 合格
  FAILED  /// 不合格
  PENDING /// 結果待ち
}

/// 学生（中核エンティティ）
model Student {
  id                     String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学籍番号（7桁: 入学年2桁 + コホート2桁 + 連番3桁）
  studentNumber          String               @unique
  /// 氏名（漢字）。漢字圏以外は null
  nameKanji              String?
  /// 氏名（カナ）
  nameKana               String?
  /// 氏名（英語）。パスポート記載名
  nameEn                 String
  /// 生年月日
  dateOfBirth            DateTime             @db.Date
  /// 性別
  gender                 Gender
  /// 国籍
  nationality            String
  /// ステータス
  status                 StudentStatus        @default(PRE_ENROLLMENT)
  /// 入学前詳細ステータス（ステータスが PRE_ENROLLMENT の場合のみ）
  preEnrollmentStatus    PreEnrollmentStatus? @default(APPLICATION_PLANNED)
  /// 入学年月日
  enrollmentDate         DateTime?            @db.Date
  /// 卒業予定日（コホートから自動算出）
  expectedGraduationDate DateTime?            @db.Date
  /// コホート
  cohort                 Cohort
  /// 電話番号
  phone                  String?
  /// メールアドレス
  email                  String?
  /// 日本の住所
  addressJapan           String?
  /// 母国の住所
  addressHome            String?
  /// 緊急連絡先（氏名）
  emergencyContactName   String?
  /// 緊急連絡先（電話番号）
  emergencyContactPhone  String?
  /// パスポート番号
  passportNumber         String?
  /// 在留カード番号
  residenceCardNumber    String?
  /// 在留資格（「留学」が基本）
  residenceStatus        String?
  /// 在留期限（ビザ更新アラートのトリガー）
  residenceExpiry        DateTime?            @db.Date
  /// 入国日
  entryDate              DateTime?            @db.Date
  /// 入国空港
  entryAirport           String?
  /// 便名
  flightNumber           String?
  /// 出迎え担当スタッフID
  pickupStaffId          String?              @db.Uuid
  /// 資格外活動許可
  workPermitStatus       Boolean              @default(false)
  /// 資格外活動許可日
  workPermitDate         DateTime?            @db.Date
  /// 資格外活動許可期限
  workPermitExpiry       DateTime?            @db.Date
  /// 国民健康保険番号
  healthInsuranceNumber  String?
  /// 健康保険加入日
  healthInsuranceDate    DateTime?            @db.Date
  /// エージェントID（上書き禁止）
  agentId                String?              @db.Uuid
  /// 進路区分
  careerPath             CareerPath?
  /// 進路先名
  careerDestination      String?
  /// 進路合否
  careerResult           CareerResult?
  /// 退学日（上書き禁止。入管報告との整合性）
  withdrawalDate         DateTime?            @db.Date
  /// 退学理由
  withdrawalReason       String?
  /// 備考
  notes                  String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  /// エージェント (N:1)
  agent       Agent? @relation(fields: [agentId], references: [id], onDelete: Restrict)
  /// 出迎え担当スタッフ (N:1)
  pickupStaff Staff? @relation("PickupStaff", fields: [pickupStaffId], references: [id], onDelete: Restrict)

  /// 勤務先情報 (1:N, 最大3件)
  employments          StudentEmployment[]
  /// 資格証情報 (1:N)
  certifications       StudentCertification[]
  /// 面談記録 (1:N)
  interviewRecords     InterviewRecord[]
  /// クラス在籍履歴 (1:N)
  classEnrollments     ClassEnrollment[]
  /// 出欠記録 (1:N)
  attendanceRecords    AttendanceRecord[]
  /// 月次出席率 (1:N)
  monthlyAttendanceRates MonthlyAttendanceRate[]
  /// 請求 (1:N)
  invoices             Invoice[]
  /// 入金 (1:N)
  payments             Payment[]
  /// 入寮履歴 (1:N)
  dormitoryAssignments DormitoryAssignment[]
  /// 月次残高 (1:N)
  monthlyBalances      MonthlyBalance[]
  /// 申請ケース (1:N)
  applicationCases     ApplicationCase[]
  /// 特定技能案件 (1:N)
  sswCases             SswCase[]
  /// 支援計画 (1:N)
  supportPlans         SupportPlan[]
  /// 入管タスク (1:N)
  immigrationTasks     ImmigrationTask[]

  @@index([agentId])
  @@index([pickupStaffId])
  @@map("students")
}

/// 学生勤務先（アルバイト先情報。1学生あたり最大3件）
model StudentEmployment {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学生ID
  studentId    String   @db.Uuid
  /// 勤務先名
  employerName String
  /// 電話番号
  phone        String?
  /// 勤務時間（週）
  weeklyHours  Float?
  /// 時給（円）
  hourlyWage   Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  /// 所属学生
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_employments")
}

/// 面談記録
model InterviewRecord {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学生ID
  studentId     String        @db.Uuid
  /// 面談日
  interviewDate DateTime      @db.Date
  /// 面談種別
  interviewType InterviewType
  /// 担当者スタッフID
  staffId       String        @db.Uuid
  /// 内容
  content       String
  /// アクション項目
  actionItems   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  /// 対象学生
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  /// 担当者
  staff   Staff   @relation(fields: [staffId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([staffId])
  @@map("interview_records")
}

/// 資格証（JLPT・特定技能試験等の受験・合格情報）
model StudentCertification {
  id                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学生ID
  studentId         String     @db.Uuid
  /// 試験種別
  examType          ExamType
  /// レベル・級（N1〜N5、業種名など。試験によって形式が異なる）
  level             String?
  /// 受験日
  examDate          DateTime   @db.Date
  /// 合否
  result            ExamResult
  /// スコア（点数がある試験の場合）
  score             Int?
  /// 証明書番号
  certificateNumber String?
  /// 備考
  notes             String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  /// 対象学生
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_certifications")
}
