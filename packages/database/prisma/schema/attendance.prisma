/// =============================================
/// 出席管理 (05-attendance)
/// =============================================

/// 出欠ステータス
enum AttendanceStatus {
  PRESENT     /// 出席
  ABSENT      /// 欠席
  LATE        /// 遅刻（4回 = 欠席1回）
  EARLY_LEAVE /// 早退
  EXCUSED     /// 公欠（出席扱い）
  SUSPENDED   /// 出停（出席停止）
}

/// 出席率アラートレベル
enum AttendanceAlertLevel {
  NORMAL            /// 正常（80%以上）
  GUIDANCE_REQUIRED /// 指導必要（50%以上80%未満）
  REPORT_REQUIRED   /// 入管報告必要（50%未満）
}

/// 出席率報告期間
enum AttendanceTerm {
  FIRST_HALF  /// 前期（4月1日〜9月30日）
  SECOND_HALF /// 後期（10月1日〜翌年3月31日）
}

/// 報告状態
enum ReportStatus {
  PENDING   /// 未提出
  SUBMITTED /// 提出済み
}

/// 出欠記録（クラス × 学生 × 日付 × 時限）
model AttendanceRecord {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学生ID
  studentId String           @db.Uuid
  /// 日付
  date      DateTime         @db.Date
  /// 時限（1〜6）
  period    Int
  /// 出欠ステータス
  status      AttendanceStatus @default(ABSENT)
  /// 作成者スタッフID
  createdById String?          @db.Uuid
  /// 更新者スタッフID
  updatedById String?          @db.Uuid
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  /// 対象学生
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  /// 作成者
  createdBy Staff?  @relation("AttendanceRecordCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  /// 更新者
  updatedBy Staff?  @relation("AttendanceRecordUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@unique([studentId, date, period])
  @@index([studentId])
  @@index([createdById])
  @@index([updatedById])
  @@map("attendance_records")
}

/// 月次出席率（学生ごとの月次出席率。入管報告・指導判定に使用）
model MonthlyAttendanceRate {
  id             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 学生ID
  studentId      String                @db.Uuid
  /// 対象年月（YYYY-MM 形式）
  month          String
  /// 出席すべき時間数
  requiredHours  Int
  /// 出席した時間数
  attendedHours  Int
  /// 遅刻回数
  lateCount      Int                   @default(0)
  /// 遅刻換算欠席数（遅刻4回 = 欠席1回）
  lateAsAbsence  Int                   @default(0)
  /// 出席率（0.0〜1.0）
  rate           Float
  /// アラートレベル（自動算出）
  alertLevel     AttendanceAlertLevel  @default(NORMAL)
  /// 作成者スタッフID
  createdById    String?               @db.Uuid
  /// 更新者スタッフID
  updatedById    String?               @db.Uuid
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  /// 対象学生
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  /// 作成者
  createdBy Staff?  @relation("MonthlyAttendanceRateCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  /// 更新者
  updatedBy Staff?  @relation("MonthlyAttendanceRateUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@unique([studentId, month])
  @@index([studentId])
  @@index([createdById])
  @@index([updatedById])
  @@map("monthly_attendance_rates")
}

/// 半期出席率報告（入管への半期報告用の集計データ）
model SemiannualAttendanceReport {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  /// 対象期間区分（前期/後期）
  term         AttendanceTerm
  /// 対象年度
  fiscalYear   Int
  /// 全体出席率
  overallRate  Float
  /// 報告期限
  deadline     DateTime       @db.Date
  /// 報告状態
  reportStatus ReportStatus   @default(PENDING)
  /// 報告日
  reportedAt   DateTime?      @db.Date
  /// 作成者スタッフID
  createdById  String?        @db.Uuid
  /// 更新者スタッフID
  updatedById  String?        @db.Uuid
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  /// 作成者
  createdBy Staff? @relation("SemiannualAttendanceReportCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  /// 更新者
  updatedBy Staff? @relation("SemiannualAttendanceReportUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)

  @@index([createdById])
  @@index([updatedById])
  @@map("semiannual_attendance_reports")
}
